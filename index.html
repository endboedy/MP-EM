<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Monthly EM BMB</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; font-size: 12px; margin: 0; background: #f5f6fa; }
    header { background: #2d3436; color: white; padding: 10px; font-size: 14px; font-weight: bold; }
    nav { display: flex; background: #636e72; }
    nav button { flex: 1; padding: 8px; border: none; cursor: pointer; background: #636e72; color: white; font-size: 12px; transition: 0.3s; }
    nav button:hover, nav button.active { background: #0984e3; }
    .menu { display: none; padding: 15px; }
    .menu.active { display: block; }
    h3 { margin-top: 0; color: #2d3436; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
    th, td { border: 1px solid #ccc; padding: 4px 6px; text-align: left; cursor: default; }
    th { background: #dfe6e9; cursor: pointer; user-select: none; }
    th:hover { background: #b2bec3; }
    tr:nth-child(even) { background: #f9f9f9; }
    tr:hover { background: #fff7e6; }
    .filter-bar input { margin: 2px; padding: 3px; font-size: 11px; }
    .btn { padding: 5px 10px; margin: 4px 2px; font-size: 12px; border: none; cursor: pointer; background: #0984e3; color: white; border-radius: 3px; }
    .btn:hover { background: #74b9ff; }
    .action-btn { padding: 4px 8px; margin-left:4px; cursor:pointer; border-radius:3px; border:1px solid #ccc; background:#fff; }
    .action-btn:hover { background:#f0f0f0; }
    .empty-msg { padding:12px; color:#666; background:#fff; border:1px solid #eee; margin-top:8px; }
    .sorted-asc::after { content: " ▲"; font-size: 10px; }
    .sorted-desc::after { content: " ▼"; font-size: 10px; }
  </style>
</head>
<body>

<header>📊 Monthly EM BMB</header>

<nav>
  <button class="active" onclick="showMenu('menu1', this)">Data Order</button>
  <button onclick="showMenu('menu2', this)">Add Order MP</button>
  <button onclick="showMenu('menu3', this)">List Order MP</button>
  <button onclick="showMenu('menu4', this)">Marge</button>
</nav>

<!-- Menu 1 -->
<div id="menu1" class="menu active">
  <h3>Data Order</h3>
  <div class="filter-bar">
    <input type="text" id="fRoom" placeholder="Filter Room" oninput="applyFilter1()">
    <input type="text" id="fOrder" placeholder="Filter Order" oninput="applyFilter1()">
    <input type="text" id="fMAT" placeholder="Filter MAT" oninput="applyFilter1()">
    <input type="text" id="fCPH" placeholder="Filter CPH" oninput="applyFilter1()">
    <input type="text" id="fSection" placeholder="Filter Section" oninput="applyFilter1()">
  </div>
  <input type="file" id="uploadExcel" accept=".xlsx,.xls">
  <button class="btn" onclick="generateFinal()">🔄 Load Gabungan</button>
  <div id="table1"></div>
</div>

<!-- Menu 2 -->
<div id="menu2" class="menu">
  <h3>Add Order MP</h3>
  <textarea id="orderList" rows="4" cols="60" placeholder="Paste orders here (one per line)"></textarea><br>
  <button class="btn" onclick="addOrders()">Add Orders</button>
  <button class="btn" onclick="loadOrdersFromExcel()">🔄 Load (match Excel)</button>
  <button class="btn" onclick="recalcIncludeExclude()">🔄 Load Include/Exclude</button>
  <button class="btn" onclick="saveJSON()">💾 Save JSON</button>
  <input type="file" id="loadJSON" style="display:none" accept=".json" onchange="loadJSONFile(event)">
  <button class="btn" onclick="document.getElementById('loadJSON').click()">📂 Load JSON</button>

  <div class="filter-bar" style="margin-top:8px;">
    <input type="text" id="filterRoom" placeholder="Filter Room" oninput="filterOrders()">
    <input type="text" id="filterOrder" placeholder="Filter Order" oninput="filterOrders()">
    <input type="text" id="filterMAT" placeholder="Filter MAT" oninput="filterOrders()">
  </div>
  <div id="table2"></div>
</div>

<!-- Menu 3 -->
<div id="menu3" class="menu">
  <h3>List Order MP</h3>
  <button class="btn" onclick="loadListMP()">🔄 Load Data</button>
  <button class="btn" onclick="downloadExcel3()">📥 Download Excel</button>
  <select id="monthFilter" onchange="filterByMonth()">
    <option value="">-- Pilih Month --</option>
  </select>
  <div class="filter-bar" style="margin-top:8px;">
    <input type="text" id="fRoom3" placeholder="Filter Room" oninput="applyFilter3()">
    <input type="text" id="fOrder3" placeholder="Filter Order" oninput="applyFilter3()">
    <input type="text" id="fMAT3" placeholder="Filter MAT" oninput="applyFilter3()">
    <input type="text" id="fCPH3" placeholder="Filter CPH" oninput="applyFilter3()">
    <input type="text" id="fSection3" placeholder="Filter Section" oninput="applyFilter3()">
  </div>
  <div id="table3"></div>
</div>
	
<!-- Tambahkan library SheetJS -->
<script src="https://cdn.sheetjs.com/xlsx-0.18.5/package/dist/xlsx.full.min.js"></script>

<!-- MENU 4 -->
<div id="menu4" class="menu">
  <h2>Merge</h2>
  <div class="panel" id="panel-json" data-hidden="false">
    <button id="toggleJson">⬆ Hide</button>
    <div class="panel-content">
      <p>Upload sampai 5 file JSON untuk digabung:</p>
      <input type="file" id="json1" accept=".json"><br>
      <input type="file" id="json2" accept=".json"><br>
      <input type="file" id="json3" accept=".json"><br>
      <input type="file" id="json4" accept=".json"><br>
      <input type="file" id="json5" accept=".json"><br>
      <div style="margin-top:8px;">
        <button class="btn btn-primary" onclick="mergeJson()">Gabungkan</button>
        <button class="btn btn-success" onclick="downloadJson()">Download JSON</button>
      </div>
    </div>
  </div>

<!-- FILTER: dropdown kolom + input -->
  <div style="display:flex; gap:8px; margin:10px 0; align-items:center;">
    <select id="filterColumn" onchange="filterTable()" style="flex:0 0 120px; padding:4px;">
      <option value="">--Pilih kolom--</option>
      <!-- Opsi akan diisi otomatis oleh renderTable() -->
    </select>

    <input type="text" id="searchInput" placeholder="Masukkan nilai filter..." 
           oninput="filterTable()" 
           style="flex:1; padding:4px;">
  </div>

  <!-- Tabel hasil merge -->
  <div id="tableJson"></div>
</div>

<!-- Script -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
let budgetData = {}; // simpan Budget per CPH

// Buka popup budget
function openBudgetPopup() {
  if(!finalData || finalData.length===0){ alert("Gabungkan dulu data di Menu 1!"); return; }
  const cphList = ["RM","PCR","UCR","TYRE","GET-BBB","BACKLOG","External Job","Fluid","SSA","Other"];
  const container = document.getElementById("budgetInputs");
  container.innerHTML = "";
  cphList.forEach(cph=>{
    const div = document.createElement("div");
    div.style.marginBottom = "6px";
    div.innerHTML = `<label style="width:120px;display:inline-block;text-align:left">${cph}</label>
                     <input type="number" value="${budgetData[cph]||0}" style="width:100px; text-align:right;" id="budget_${cph}">`;
    container.appendChild(div);
  });
  document.getElementById("budgetPopup").style.display = "block";
}

// Tutup popup
function closeBudgetPopup() {
  document.getElementById("budgetPopup").style.display = "none";
}

// Simpan input budget ke object
function saveBudget() {
  const cphList = ["RM","PCR","UCR","TYRE","GET-BBB","BACKLOG","External Job","Fluid","SSA","Other"];
  cphList.forEach(cph=>{
    const val = parseFloat(document.getElementById("budget_"+cph).value) || 0;
    budgetData[cph] = val;
  });
  closeBudgetPopup();
  alert("Budget berhasil disimpan!");
}

// Save budget ke file JSON
function saveBudgetJSON() {
  if(Object.keys(budgetData).length===0){ alert("Tidak ada data budget untuk disimpan!"); return; }
  const dataStr = JSON.stringify(budgetData, null, 2);
  const blob = new Blob([dataStr], {type:"application/json"});
  const link = document.createElement("a");
  link.download = "budget.json";
  link.href = URL.createObjectURL(blob);
  link.click();
  URL.revokeObjectURL(link.href);
}

// Load budget dari file JSON
function loadBudgetJSON() {
  document.getElementById("jsonFileInput").click();
}

// Handler file JSON
function handleJSONFile(event){
  const file = event.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e){
    try{
      const json = JSON.parse(e.target.result);
      budgetData = json;
      alert("Budget berhasil di-load dari JSON!");
    }catch(err){
      alert("File JSON tidak valid!");
    }
  };
  reader.readAsText(file);
}

// Fungsi generate tabel
function generateCostRM() {
  if(!finalData || finalData.length===0){ alert("Gabungkan dulu data di Menu 1!"); return; }
  const cphList = ["RM","PCR","UCR","TYRE","GET-BBB","BACKLOG","External Job","Fluid","SSA","Other"];
  const cols = ["Budget","Include","Exclude","Wheel Type","SE Type","DT Type","Track Type"];
  const container = document.getElementById("costRMContainer");
  container.innerHTML = "";
  const table = document.createElement("table");
  table.style.borderCollapse = "collapse";
  table.style.background = "#fff";

  // header
  const trh = document.createElement("tr");
  ["CPH", ...cols].forEach(h=>{
    const th = document.createElement("th");
    th.textContent = h;
    th.style.background = "#dfe6e9";
    th.style.padding = "6px";
    th.style.border = "1px solid #ccc";
    th.style.textAlign = "center";
    th.style.width = h==="CPH"?"120px":"100px";
    trh.appendChild(th);
  });
  table.appendChild(trh);

  // rows
  cphList.forEach(cph=>{
    const tr = document.createElement("tr");

    const tdCPH = document.createElement("td");
    tdCPH.textContent = cph;
    tdCPH.style.padding = "4px";
    tdCPH.style.textAlign = "left";
    tdCPH.style.border = "1px solid #ccc";
    tr.appendChild(tdCPH);

    const tdBudget = document.createElement("td");
    tdBudget.style.textAlign = "right";
    tdBudget.style.padding = "2px";
    tdBudget.style.border = "1px solid #ccc";
    tdBudget.textContent = (budgetData[cph]||0).toLocaleString('id-ID');
    tr.appendChild(tdBudget);

    ["Include","Exclude","Wheel Type","SE Type","DT Type","Track Type"].forEach(col=>{
      const td = document.createElement("td");
      td.style.textAlign = "right";
      td.style.padding = "2px";
      td.style.border = "1px solid #ccc";
      if(["Wheel Type","SE Type","DT Type","Track Type"].includes(col)){
        td.style.background = "#ffeaa7";
      }
      td.textContent = "0";
      tr.appendChild(td);
    });

    table.appendChild(tr);
  });

  container.appendChild(table);
}

/* ===========================
   Data holders (do not change)
   =========================== */
let uploadedData = [];
let manualData = [];
let finalData = [];

/* sort state: key per container */
const sortState = {}; // { containerId: { key: 'Order', asc: true } }

/* ---------------------------
   UI helpers
   --------------------------- */
function showMenu(id, el) {
  document.querySelectorAll(".menu").forEach(m => m.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
  el.classList.add("active");
}

/* ---------------------------
   Date / number formatting
   --------------------------- */
function parseExcelDate(val) {
  if (val === null || val === undefined || val === "") return null;
  if (typeof val === "number") return new Date(Math.round((val - 25569) * 86400 * 1000));
  const d = new Date(val);
  return isNaN(d) ? null : d;
}
function formatDateDisplay(val) {
  const d = parseExcelDate(val);
  if (!d) return val === 0 || val === "0" ? "" : (val || "");
  return d.toLocaleDateString("en-GB", { day: "2-digit", month: "short", year: "numeric" });
}
function formatDollar(val) {
  if (val === "" || val === null || val === undefined) return "";
  const num = Number(String(val).toString().replace(/[^0-9.\-]/g,""));
  if (isNaN(num)) return "";
  return "$ " + num.toFixed(1);
}

/* ---------------------------
   Upload Excel (Menu 1) - keep behavior
   --------------------------- */
document.getElementById("uploadExcel").addEventListener("change", function(e){
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(evt) {
    const data = new Uint8Array(evt.target.result);
    const wb = XLSX.read(data, { type:"array" });
    const sheet = wb.SheetNames[0];
    uploadedData = XLSX.utils.sheet_to_json(wb.Sheets[sheet], { defval: "" });
    // normalize keys (trim) so header names consistent
    uploadedData = uploadedData.map(r => {
      const o = {};
      Object.keys(r).forEach(k => o[String(k).trim()] = r[k]);
      return o;
    });
    renderTable1(uploadedData);
  };
  reader.readAsArrayBuffer(file);
});

/* ---------------------------
   Sorting utility (works for dates, numbers, strings)
   containerId used to remember state
   --------------------------- */
function sortData(data, key, asc) {
  return data.slice().sort((a,b) => {
    const A = a[key], B = b[key];
    // dates
    if (["Create On","Created On","Planning","Target Date"].includes(key)) {
      const da = parseExcelDate(A), db = parseExcelDate(B);
      if (da && db) return asc ? da - db : db - da;
      if (da) return asc ? -1 : 1;
      if (db) return asc ? 1 : -1;
      return 0;
    }
    // numeric (Cost/Include/Exclude) - strip non numeric
    if (["Cost","Include","Exclude","Aging"].includes(key)) {
      const na = Number(String(A).replace(/[^0-9.\-]/g,"")) || 0;
      const nb = Number(String(B).replace(/[^0-9.\-]/g,"")) || 0;
      return asc ? na - nb : nb - na;
    }
    // fallback string compare
    const sa = (A === undefined || A === null) ? "" : String(A).toLowerCase();
    const sb = (B === undefined || B === null) ? "" : String(B).toLowerCase();
    return asc ? sa.localeCompare(sb, undefined, {numeric:true}) : sb.localeCompare(sa, undefined, {numeric:true});
  });
}

/* ---------------------------
   Generic render used by Menu 1 & 3 & others
   keeps styling, colors, date/dollar formatting and supports sorting
   --------------------------- */
function renderTableCommon(data, containerId) {
  const c = document.getElementById(containerId);
  c.innerHTML = "";
  if (!data || data.length === 0) { c.innerHTML = "<div class='empty-msg'>No data</div>"; return; }

  // keys: union of all keys to keep columns stable
  const keysSet = new Set();
  data.forEach(r => Object.keys(r).forEach(k => keysSet.add(k)));
  const keys = Array.from(keysSet);

  // apply sort state if present
  const state = sortState[containerId];
  let dataToRender = data;
  if (state && state.key) {
    dataToRender = sortData(data, state.key, state.asc);
  }

  const t = document.createElement("table");
  const hr = document.createElement("tr");
  keys.forEach(k => {
    const th = document.createElement("th");
    th.textContent = k;
    th.style.userSelect = "none";
    // show sort indicator class
    if (sortState[containerId] && sortState[containerId].key === k) {
      th.classList.add(sortState[containerId].asc ? "sorted-asc" : "sorted-desc");
    }
    th.onclick = () => {
      // toggle
      if (!sortState[containerId]) sortState[containerId] = { key: k, asc: true };
      else if (sortState[containerId].key === k) sortState[containerId].asc = !sortState[containerId].asc;
      else { sortState[containerId].key = k; sortState[containerId].asc = true; }
      // re-render
      renderTableCommon(data, containerId);
    };
    hr.appendChild(th);
  });
  t.appendChild(hr);

  dataToRender.forEach(row => {
    const tr = document.createElement("tr");
    keys.forEach(k => {
      const td = document.createElement("td");
      let v = row[k] === undefined || row[k] === null ? "" : row[k];

      // date formatting (right align)
      if (["Create On","Created On","Planning","Target Date"].includes(k)) {
        v = formatDateDisplay(v);
        td.style.textAlign = "right";
      }

      // money columns
      if (["Cost","Include","Exclude"].includes(k)) {
        td.textContent = formatDollar(v);
        td.style.textAlign = "right";
      } else {
        td.textContent = (v === undefined || v === null) ? "" : String(v);
      }

      // conditional coloring AFTER text set
      const valStr = String(v).trim();
      // User Status
      if (k === "User Status") {
        const u = valStr.toUpperCase();
        if (u === "COMP") { td.style.background = "#e74c3c"; td.style.color = "#fff"; td.style.fontWeight = "bold"; }
        if (u === "PROG") { td.style.background = "#3498db"; td.style.color = "#fff"; td.style.fontWeight = "bold"; }
        if (u === "RELE") { td.style.background = "#2ecc71"; td.style.color = "#fff"; td.style.fontWeight = "bold"; }
        if (u === "OUTS") { td.style.background = "#f1c40f"; td.style.color = "#000"; td.style.fontWeight = "bold"; }
      }
      // Status Part
      if (k === "Status Part") {
        if (valStr === "Complete") { td.style.background = "#2ecc71"; td.style.color = "#fff"; td.style.fontWeight = "bold"; }
        if (valStr === "Not Complete") { td.style.background = "#e74c3c"; td.style.color = "#fff"; td.style.fontWeight = "bold"; }
      }
      // Status AMT
      if (k === "Status AMT") {
        if (valStr === "") { td.style.background = "#95a5a6"; td.style.color = "#fff"; td.style.fontWeight = "bold"; }
        if (valStr === "O") { td.style.background = "#f1c40f"; td.style.color = "#000"; td.style.fontWeight = "bold"; }
        if (valStr === "YTS") { td.style.background = "#2ecc71"; td.style.color = "#fff"; td.style.fontWeight = "bold"; }
        if (valStr === "IP") { td.style.background = "#e74c3c"; td.style.color = "#fff"; td.style.fontWeight = "bold"; }
      }
      // Aging
      if (k === "Aging") {
        const n = Number(valStr);
        if (!isNaN(n)) {
          td.style.textAlign = "center";
          if (n < 30) { td.style.background = "#2ecc71"; td.style.color = "#fff"; td.style.fontWeight = "bold"; }
          else { td.style.background = "#e74c3c"; td.style.color = "#fff"; td.style.fontWeight = "bold"; }
        }
      }

      tr.appendChild(td);
    });
    t.appendChild(tr);
  });

  c.appendChild(t);
}

/* ---------------------------
   Menu1 rendering wrapper (keeps previous logic)
   --------------------------- */
function renderTable1(data) {
  // Keep behavior consistent with previous versions
  renderTableCommon(data, "table1");
}

/* ---------------------------
   Filtering for Menu1 (source = finalData if exists else uploadedData)
   --------------------------- */
function applyFilter1(){
  const rf = document.getElementById("fRoom").value.trim().toLowerCase();
  const of = document.getElementById("fOrder").value.trim().toLowerCase();
  const mf = document.getElementById("fMAT").value.trim().toLowerCase();
  const cf = document.getElementById("fCPH") ? document.getElementById("fCPH").value.trim().toLowerCase() : "";
  const sf = document.getElementById("fSection") ? document.getElementById("fSection").value.trim().toLowerCase() : "";

  const source = (finalData && finalData.length) ? finalData : uploadedData;
  const filtered = source.filter(r =>
    (!rf || String(r.Room || "").toLowerCase().includes(rf)) &&
    (!of || String(r.Order || "").toLowerCase().includes(of)) &&
    (!mf || String(r.MAT || "").toLowerCase().includes(mf)) &&
    (!cf || String(r.CPH || "").toLowerCase().includes(cf)) &&
    (!sf || String(r.Section || "").toLowerCase().includes(sf))
  );
  renderTable1(filtered);
}

/* ---------------------------
   Menu2 (unchanged logic)
   --------------------------- */
function addOrders(){
  const lines = String(document.getElementById("orderList").value || "").trim().split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  lines.forEach(l => {
    if (!manualData.find(m => String(m.Order).trim() === String(l).trim())) {
      manualData.push({ Order: l.trim(), Month: "", Reman: "", Cost: "", Include: "", Exclude: "" });
    }
  });
  document.getElementById("orderList").value = ""; // clear after add
  renderOrderTable();
}

function renderOrderTable(list = null) {
  const container = document.getElementById("table2");
  container.innerHTML = "";
  const data = list || manualData;
  if (!data || data.length === 0) { container.innerHTML = "<div class='empty-msg'>No orders</div>"; return; }

  const headers = ["Room", "Order Type", "Order", "Description", "MAT", "Month", "Reman", "Cost", "Include", "Exclude", "Action"];
  const t = document.createElement("table");
  const hr = document.createElement("tr");
  headers.forEach(h => { const th = document.createElement("th"); th.textContent = h; th.onclick = () => { // header sort for menu2 table
    const key = h;
    const containerId = "table2";
    if (!sortState[containerId]) sortState[containerId] = { key: key, asc: true };
    else if (sortState[containerId].key === key) sortState[containerId].asc = !sortState[containerId].asc;
    else { sortState[containerId] = { key: key, asc: true }; }
    // perform simple sort on manualData copy
    const sorted = sortData(data, sortState[containerId].key, sortState[containerId].asc);
    renderOrderTable(sorted);
  }; hr.appendChild(th); });
  t.appendChild(hr);

  data.forEach((r, i) => {
    const tr = document.createElement("tr");
    headers.forEach(h => {
      const td = document.createElement("td");

      if (h === "Month" || h === "Reman") {
        td.contentEditable = true;
        td.textContent = r[h] || "";
        td.onblur = () => { r[h] = td.textContent.trim(); };
      } else if (h === "Cost") {
        const v = r.Cost === "" || r.Cost === undefined ? "" : r.Cost;
        td.contentEditable = true;
        td.style.textAlign = "right";
        td.textContent = v ? formatDollar(v) : "";
        td.onblur = () => {
          const raw = td.textContent.replace(/[^0-9.\-]/g, "");
          const n = parseFloat(raw);
          r.Cost = isNaN(n) ? "" : n.toFixed(1);
          td.textContent = r.Cost ? formatDollar(r.Cost) : "";
        };
      } else if (h === "Include" || h === "Exclude") {
        td.style.textAlign = "right";
        td.textContent = r[h] ? formatDollar(r[h]) : "";
      } else if (h === "Action") {
        const del = document.createElement("button"); del.textContent = "Delete"; del.className = "action-btn";
        del.onclick = () => { manualData.splice(i, 1); renderOrderTable(); };
        td.appendChild(del);
      } else {
        td.textContent = r[h] || "";
      }

      tr.appendChild(td);
    });
    t.appendChild(tr);
  });

  container.appendChild(t);
}

function loadOrdersFromExcel() {
  if (!uploadedData || !uploadedData.length) { alert("Upload Excel dulu di Menu 1"); return; }
  let matched = 0;
  manualData.forEach(m => {
    const found = uploadedData.find(u => String(u.Order).trim() === String(m.Order).trim());
    if (found) {
      m.Room = found.Room || "";
      m["Order Type"] = found["Order Type"] || found.OrderType || "";
      m.Description = found.Description || "";
      m.MAT = found.MAT || "";
      const cval = found.Cost !== undefined && found.Cost !== null ? String(found.Cost).trim() : "";
      const num = Number(cval.toString().replace(/[^0-9.\-]/g,""));
      m.Cost = isNaN(num) ? (m.Cost || "") : num.toFixed(1);
      matched++;
    }
    // Clear Include/Exclude until user runs recalc
    m.Include = "";
    m.Exclude = "";
  });
  renderOrderTable();
  alert("Load complete. Matched: " + matched);
}

function recalcIncludeExclude() {
  manualData.forEach(m => {
    const costNum = parseFloat(m.Cost) || 0;
    if (String(m.Reman || "").trim().toLowerCase() === "reman") {
      m.Include = (costNum * 0.25).toFixed(1);
    } else {
      m.Include = costNum ? costNum.toFixed(1) : "";
    }
    m.Exclude = (String(m["Order Type"] || "").trim() === "PM38") ? "" : (m.Include || "");
  });
  renderOrderTable();
}

/* JSON */
function saveJSON() {
  const blob = new Blob([JSON.stringify(manualData, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "manual_orders.json";
  a.click();
}
function loadJSONFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  const fr = new FileReader();
  fr.onload = function(evt) {
    try {
      manualData = JSON.parse(evt.target.result);
      renderOrderTable();
    } catch (err) {
      alert("JSON tidak valid");
    }
  };
  fr.readAsText(file);
}
function filterOrders() {
  const rf = document.getElementById("filterRoom").value.trim().toLowerCase();
  const of = document.getElementById("filterOrder").value.trim().toLowerCase();
  const mf = document.getElementById("filterMAT").value.trim().toLowerCase();
  const filtered = manualData.filter(r =>
    (!rf || String(r.Room || "").toLowerCase().includes(rf)) &&
    (!of || String(r.Order || "").toLowerCase().includes(of)) &&
    (!mf || String(r.MAT || "").toLowerCase().includes(mf))
  );
  renderOrderTable(filtered);
}

/* ---------------------------
   Generate final (Menu1 Load Gabungan)
   Keep merge logic: uploadedData base + manual fields
   --------------------------- */
function generateFinal() {
  if (!uploadedData || uploadedData.length === 0) { alert("Upload Excel dulu di Menu 1."); return; }
  finalData = uploadedData.map(u => {
    const orderKey = String(u.Order || "").trim();
    const manualMatch = manualData.find(m => String(m.Order || "").trim() === orderKey) || {};
    const merged = Object.assign({}, u);
    merged.Month = manualMatch.Month || "";
    merged.Reman = manualMatch.Reman || "";
    merged.Include = manualMatch.Include || "";
    merged.Exclude = manualMatch.Exclude || "";
    if (manualMatch && manualMatch.Cost !== undefined && manualMatch.Cost !== "") merged.Cost = manualMatch.Cost;
    return merged;
  });
  renderTable1(finalData);
  updateMonthFilter();
}

/* ---------------------------
   Menu 3: load, filter by month and filter bar; use same renderTableCommon
   --------------------------- */
function updateMonthFilter() {
  const select = document.getElementById("monthFilter");
  const months = [...new Set(finalData.map(d => d.Month).filter(Boolean))];
  select.innerHTML = "<option value=''>-- Pilih Month --</option>" + months.map(m => `<option value="${m}">${m}</option>`).join("");
}

function loadListMP() {
  if (!finalData || finalData.length === 0) { 
    alert("Jalankan Load Gabungan di Menu 1 terlebih dahulu."); 
    return; 
  }
  filteredData3 = finalData.slice();
  renderTableCommon(filteredData3, "table3");
  updateMonthFilter();
}

function filterByMonth() {
  const m = document.getElementById("monthFilter").value;
  filteredData3 = finalData.filter(r => !m || r.Month === m);
  renderTableCommon(filteredData3, "table3");
}

function applyFilter3() {
  const rf = document.getElementById("fRoom3").value.trim().toLowerCase();
  const of = document.getElementById("fOrder3").value.trim().toLowerCase();
  const mf = document.getElementById("fMAT3").value.trim().toLowerCase();
  const cf = document.getElementById("fCPH3") ? document.getElementById("fCPH3").value.trim().toLowerCase() : "";
  const sf = document.getElementById("fSection3") ? document.getElementById("fSection3").value.trim().toLowerCase() : "";

  const filtered = filteredData3.filter(r =>
    (!rf || String(r.Room || "").toLowerCase().includes(rf)) &&
    (!of || String(r.Order || "").toLowerCase().includes(of)) &&
    (!mf || String(r.MAT || "").toLowerCase().includes(mf)) &&
    (!cf || String(r.CPH || "").toLowerCase().includes(cf)) &&
    (!sf || String(r.Section || "").toLowerCase().includes(sf))
  );
  renderTableCommon(filtered, "table3");
}

// ==========================
// Download Excel untuk Menu 3
// ==========================
function downloadExcel3() {
  if(!filteredData3 || filteredData3.length===0){
    alert("Tidak ada data untuk di-download!");
    return;
  }

  // konversi array object ke worksheet
  const ws = XLSX.utils.json_to_sheet(filteredData3);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "ListOrderMP");

  // download file
  XLSX.writeFile(wb, "ListOrderMP.xlsx");
}

// Toggle panel JSON
document.getElementById('toggleJson').addEventListener('click', () => {
  const panel = document.getElementById('panel-json');
  const content = panel.querySelector('.panel-content');
  const hidden = panel.getAttribute('data-hidden') === 'true';
  if (hidden) {
    content.style.display = 'block';
    panel.setAttribute('data-hidden', 'false');
    document.getElementById('toggleJson').textContent = '⬆ Hide';
  } else {
    content.style.display = 'none';
    panel.setAttribute('data-hidden', 'true');
    document.getElementById('toggleJson').textContent = '⬇ Show';
  }
});

window.mergedData = [];
let currentSort = { key: null, asc: true };

// Merge JSON
async function mergeJson() {
  const allData = [];

  for (let i = 1; i <= 5; i++) {
    const inp = document.getElementById('json' + i);
    if (inp && inp.files && inp.files.length > 0) {
      try {
        const text = await inp.files[0].text();
        const json = JSON.parse(text);
        if (Array.isArray(json)) allData.push(...json);
        else allData.push(json);
      } catch (e) {
        alert('File JSON ke-' + i + ' tidak valid!\n' + e.message);
        return;
      }
    }
  }

  // Hilangkan duplikat
  const uniqueData = [];
  const seen = new Set();
  allData.forEach(item => {
    const key = JSON.stringify(item);
    if (!seen.has(key)) {
      seen.add(key);
      uniqueData.push(item);
    }
  });

  window.mergedData = uniqueData;
  renderTable(window.mergedData);
}

// Render tabel
function renderTable(data) {
  window.displayedData = data; // data yang sedang ditampilkan
  const container = document.getElementById('tableJson');
  if (!data || data.length === 0) {
    container.innerHTML = '<p>Tidak ada data untuk ditampilkan.</p>';
    return;
  }

  // Hitung duplikat berdasarkan Order
  const orderCount = {};
  data.forEach(item => {
    const order = item.Order || item.order;
    if (order) orderCount[order] = (orderCount[order] || 0) + 1;
  });

  let html = '<table border="1" cellpadding="4" cellspacing="0"><thead><tr>';
  for (const key in data[0]) {
    html += `<th onclick="sortTable('${key}')">${key} ⬍</th>`;
  }
  html += '<th>Action</th></tr></thead><tbody>';

  data.forEach((row, index) => {
    const order = row.Order || row.order;
    const isDuplicate = order && orderCount[order] > 1;
    html += `<tr style="${isDuplicate ? 'background-color:#ffdddd;' : ''}">`;
    for (const key in row) {
      html += `<td>${row[key]}</td>`;
    }
    html += `<td><button onclick="deleteRow(${index})">Delete</button></td>`;
    html += '</tr>';
  });

  html += '</tbody></table>';
  container.innerHTML = html;

  // Isi dropdown filter kolom otomatis
  const colSelect = document.getElementById('filterColumn');
  if (colSelect && data.length > 0) {
    const selected = colSelect.value; // simpan pilihan sebelumnya
    colSelect.innerHTML = '<option value="">--Pilih kolom--</option>';
    Object.keys(data[0]).forEach(key => {
      colSelect.innerHTML += `<option value="${key}" ${selected === key ? 'selected' : ''}>${key}</option>`;
    });
  }
}

// Delete row
function deleteRow(index) {
  const itemToDelete = window.displayedData[index];
  const orderToDelete = itemToDelete.Order || itemToDelete.order;

  const originalIndex = window.mergedData.findIndex(item => {
    const order = item.Order || item.order;
    return order === orderToDelete;
  });

  if (originalIndex !== -1 && confirm('Yakin ingin menghapus baris ini?')) {
    window.mergedData.splice(originalIndex, 1);
    renderTable(window.mergedData);
  }
}

// Download JSON
function downloadJson() {
  if (!window.mergedData || window.mergedData.length === 0) {
    alert('Tidak ada data untuk di-download');
    return;
  }

  const blob = new Blob([JSON.stringify(window.mergedData, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'merged.json';
  a.click();
  URL.revokeObjectURL(url);
}

// FILTER berdasarkan kolom
function filterTable() {
  const colSelect = document.getElementById('filterColumn');
  const input = document.getElementById('searchInput');
  const col = colSelect ? colSelect.value : null;
  const val = input ? input.value.toLowerCase() : '';

  if (!col || !val) {
    renderTable(window.mergedData);
    return;
  }

  const filtered = window.mergedData.filter(item => {
    return String(item[col] ?? '').toLowerCase().includes(val);
  });

  renderTable(filtered);
}

// Sort tabel
function sortTable(key) {
  if (!window.mergedData || window.mergedData.length === 0) return;

  const asc = currentSort.key === key ? !currentSort.asc : true;
  currentSort = { key, asc };

  window.mergedData.sort((a, b) => {
    const valA = a[key] ?? '';
    const valB = b[key] ?? '';

    const numA = parseFloat(valA);
    const numB = parseFloat(valB);

    if (!isNaN(numA) && !isNaN(numB)) {
      return asc ? numA - numB : numB - numA;
    }

    return asc
      ? String(valA).localeCompare(String(valB))
      : String(valB).localeCompare(String(valA));
  });

  renderTable(window.mergedData);
}



</script>
</body>
</html>
